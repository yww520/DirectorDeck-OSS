# dierctordeck3.0 修改日志

## 2026-01-13

### 剧本分镜库 (StoryboardLibrary) 优化

#### 🐛 Bug 修复

1. **修复 Gemini 1.5 Flash 404 错误**
   - 针对部分用户遇到的 `models/gemini-1.5-flash is not found for API version v1beta` 错误，将默认模型别名更新为更稳定的 `gemini-1.5-flash-latest`。
   - 优化了模型供应商启发式算法，增强了对第三方代理（如 Antigravity）的型号兼容性。

#### 🚀 新功能

1. **智能网页链接识别**
   - 剧本分镜库中的所有文本字段（描述、地点、对话、音效、AI 提示词）现在都支持自动识别并渲染为可点击的网页链接。
   - 项目标题也支持链接识别。
   - 链接以品牌色 `cine-accent` 高亮显示，点击后可在新窗口中打开。
   - 采用正则表达式自动检测 `http://` 和 `https://` 开头的链接。

---

## 2026-01-03

### 配音面板 (DubbingPanel) 优化

#### 🚀 新功能

1. **前端状态持久化**
   - 刷新页面后自动恢复：台词文本、选中角色、情感参数、生成的音频URL
   - 使用 `localStorage` 存储，即时保存
   - 状态恢复时会在控制台打印日志 `[DubbingPanel] Restored state from localStorage`

2. **后端智能缓存（已有）**
   - 相同的 文本 + 音色 + 情感设置 会自动命中缓存
   - 缓存命中时立即返回结果（"发现缓存，瞬间完成！"）
   - 缓存存储在 `outputs/cache_manifest.json`

3. **下载按钮**
   - 生成结果区域新增下载按钮（黄绿色高亮）
   - 文件名格式：`{角色名}_{时间戳}.wav`
   - 下载成功后显示提示

4. **不确定进度动画**
   - 移除卡顿的百分比进度条
   - 改为 shimmer 光效 + 旋转加载动画
   - 显示提示：首次生成约需 10-30 秒，相同设置将瞬间完成

#### 🐛 Bug 修复

1. **SSE 进度条卡顿修复**
   - 增加 10 分钟超时机制，避免无限等待
   - 增强 SSE 完成检测，支持多种响应格式：
     - `msg.output.data[0]`
     - `msg.output[0]`、`msg.data[0]`
     - 直接的 `{path, url, name}` 对象
     - 数组格式响应
     - Windows 绝对路径字符串
   - 增加 `is_generating: false` 模式检测
   - 持续进度反馈：即使 SSE 没有返回进度，也会缓慢递增（最高 92%）

2. **URL 构建增强**
   - 正确处理 Windows 绝对路径格式
   - 从 `E:\index-tts-windows\outputs\xxx.wav` 提取 `outputs/xxx.wav`
   - 添加调试日志便于问题排查

3. **上传音频后角色选中状态消失**
   - 修复：上传自定义参考音频时不再清除已选中的角色

4. **上传区域点击无响应**
   - 将上传区域改为 `<label>` 包裹 `<input>`，确保点击任何位置都能触发文件选择器

5. **切换标签后状态丢失**
   - 将 DubbingPanel 改为始终挂载（CSS `hidden` 隐藏），而非条件渲染
   - 切换标签后生成的音频、输入的文本、选中的角色等状态都会保留

#### ✨ UI 优化

1. **颜色统一**
   - 自定义参考区域：`indigo`（靛蓝）→ `cine-accent`（黄绿色）
   - 情感控制区域标题图标：`indigo` → `emerald`（翠绿色）

2. **布局对齐**
   - 右侧情感控制区域改为 `flex flex-col` + `flex-1`
   - 自动拉伸填满高度，与左侧上传区域对齐

3. **并列布局**
   - 台词输入框与生成结果区域并排显示（`grid-cols-2`）
   - 右侧结果区域显示三种状态：等待生成、生成中进度条、完成后播放控件

---

### 文件修改清单

| 文件 | 修改内容 |
|------|----------|
| `App.tsx` | DubbingPanel 改为 CSS 隐藏方式保持状态 |
| `DubbingPanel.tsx` | SSE 解析优化、URL 构建、颜色统一、布局对齐、上传区域修复 |
